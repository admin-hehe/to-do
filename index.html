<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To Do</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = { darkMode: 'class' }

        // Instant Theme Apply
        function applyTheme() {
            const theme = localStorage.getItem('color-theme');
            const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (theme === 'dark' || (!theme && systemDark)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }
        applyTheme();
    </script>

    <style>
        body { font-family: 'Outfit', sans-serif; transition: background-color 0.3s ease; }
        .hidden { display: none !important; }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #334155; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-[#020617] text-slate-900 dark:text-slate-100 min-h-screen p-4 md:p-12 transition-colors duration-500">

    <div class="max-w-4xl mx-auto">
        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-10 gap-4">
            <div>
                <h1 class="text-3xl font-bold tracking-tight">To Do</h1>
                <p id="currentDate" class="text-slate-500 dark:text-slate-400 font-medium text-sm"></p>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="toggleTheme()" class="p-3 rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-sm hover:scale-110 transition active:scale-95 group">
                    <span id="themeIcon" class="text-sm block group-hover:rotate-[20deg] transition-transform duration-300"></span>
                </button>
                <div class="flex items-center gap-2 bg-white dark:bg-slate-900 px-4 py-3 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800 text-[10px] font-bold uppercase tracking-widest">
                    <div id="statusDot" class="h-2 w-2 rounded-full bg-blue-500"></div>
                    <span id="statusText">Online</span>
                </div>
            </div>
        </header>

        <div class="bg-white/70 dark:bg-slate-900/70 backdrop-blur-md border border-white/80 dark:border-slate-800 p-4 sm:p-6 rounded-[2.5rem] mb-12 shadow-sm">
            <div class="flex flex-col gap-4">
                <input type="text" id="taskInput" placeholder="What's the next mission?" 
                       class="w-full bg-slate-100/50 dark:bg-slate-800/50 rounded-2xl px-6 py-4 outline-none border border-transparent focus:border-blue-400 dark:focus:border-blue-500 transition-all font-medium">
                <div class="flex flex-col sm:flex-row gap-3">
                    <input type="date" id="dateInput" class="flex-1 bg-slate-100/50 dark:bg-slate-800/50 rounded-2xl px-6 py-4 outline-none border border-transparent text-sm">
                    <select id="priority" class="flex-1 bg-slate-100/50 dark:bg-slate-800/50 rounded-2xl px-6 py-4 outline-none border border-transparent text-sm cursor-pointer appearance-none">
                        <option value="Normal">Normal</option>
                        <option value="High">Priority ðŸ”¥</option>
                    </select>
                    <button onclick="saveTask()" class="bg-blue-600 hover:bg-blue-500 text-white px-10 py-4 rounded-2xl font-bold text-sm shadow-lg shadow-blue-500/30 active:scale-95 transition-all uppercase tracking-widest">
                        Deploy
                    </button>
                </div>
            </div>
        </div>

        <div class="space-y-12">
            <section>
                <div onclick="toggleMinimize('activeSection', 'activeArrow')" class="flex items-center justify-between mb-6 px-2 cursor-pointer group select-none">
                    <div class="flex items-center gap-3">
                        <div class="h-2 w-2 bg-blue-500 rounded-full shadow-[0_0_10px_rgba(59,130,246,0.5)]"></div>
                        <h2 class="font-bold text-sm tracking-widest uppercase opacity-60">Active Missions</h2>
                        <span id="countActive" class="text-[10px] font-bold bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 px-2 py-0.5 rounded-full">0</span>
                    </div>
                    <span id="activeArrow" class="text-[10px] transition-transform duration-300">â–¼</span>
                </div>
                <div id="activeSection" class="space-y-4">
                    <div id="activeContainer" class="space-y-4"></div>
                </div>
            </section>

            <section>
                <div onclick="toggleMinimize('archiveSection', 'archiveArrow')" class="flex items-center justify-between mb-6 px-2 cursor-pointer opacity-50 group select-none">
                    <div class="flex items-center gap-3">
                        <div class="h-2 w-2 bg-slate-400 rounded-full"></div>
                        <h2 class="font-bold text-sm tracking-widest uppercase">Archived</h2>
                    </div>
                    <span id="archiveArrow" class="text-[10px] transition-transform duration-300">â–¼</span>
                </div>
                <div id="archiveSection" class="space-y-4">
                    <div id="completedContainer" class="space-y-4 opacity-70"></div>
                </div>
            </section>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxEZLGNOK_sZpp1sjckOG7kEz3rtKh8fht9kfy5mk2D7IU2aSdMY79gTw5etABapC4/exec";

        window.onload = () => {
            const now = new Date();
            document.getElementById('currentDate').innerText = now.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long' });
            syncIcon();
            loadTasks();
        };

        function syncIcon() {
            const iconEl = document.getElementById('themeIcon');
            iconEl.innerText = document.documentElement.classList.contains('dark') ? "ðŸŒ™" : "â˜€ï¸";
        }

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('color-theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            syncIcon();
        }

        function toggleMinimize(sectionId, arrowId) {
            const el = document.getElementById(sectionId);
            const arrow = document.getElementById(arrowId);
            el.classList.toggle('hidden');
            arrow.style.transform = el.classList.contains('hidden') ? "rotate(-90deg)" : "rotate(0deg)";
        }

        async function loadTasks() {
            setLoading(true);
            try {
                const res = await fetch(`${SCRIPT_URL}?action=getTasks`);
                const tasks = await res.json();
                renderTasks(tasks);
                setLoading(false);
            } catch (err) {
                document.getElementById('statusText').innerText = "Offline";
            }
        }

        function renderTasks(tasks) {
            const activeCont = document.getElementById('activeContainer');
            const compCont = document.getElementById('completedContainer');
            activeCont.innerHTML = ''; compCont.innerHTML = '';
            
            let activeCount = 0;

            tasks.forEach((task, idx) => {
                const isHigh = task.Priority === 'High';
                const dateObj = (task.DueDate && task.DueDate !== "-") ? new Date(task.DueDate) : null;
                const formattedDate = dateObj ? dateObj.toLocaleDateString('id-ID', { month: 'short', day: 'numeric' }) : "Soon";
                
                const card = `
                    <div class="bg-white/70 dark:bg-slate-900/70 backdrop-blur-md border border-white/80 dark:border-slate-800 p-5 rounded-[1.5rem] shadow-sm hover:-translate-y-1 hover:shadow-xl hover:bg-white/90 dark:hover:bg-slate-800/90 transition-all duration-300 animate__animated animate__fadeInUp" style="animation-delay: ${idx * 0.05}s">
                        <div class="flex items-center justify-between gap-4"> <div class="flex items-center gap-4 flex-1"> ${task.Status === 'Active' ? 
                                    `<button onclick="done('${task.TaskID}')" class="h-6 w-6 rounded-lg border-2 border-slate-200 dark:border-slate-700 hover:border-blue-500 transition-all flex items-center justify-center group flex-shrink-0">
                                        <div class="h-3 w-3 bg-blue-500 rounded-sm opacity-0 group-hover:opacity-100 transition-all"></div>
                                    </button>` : 
                                    `<div class="h-6 w-6 rounded-lg bg-blue-500/20 flex items-center justify-center flex-shrink-0"><svg class="w-3 h-3 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg></div>`
                                }
                                <div class="flex flex-col">
                                    <h3 class="font-semibold text-sm leading-tight ${task.Status === 'Completed' ? 'line-through opacity-50' : ''}">${task.TaskName}</h3>
                                    <div class="flex flex-wrap items-center gap-2 mt-1.5 text-[9px] font-bold uppercase tracking-widest">
                                        <span class="${task.Category.includes('Work') ? 'text-blue-500' : 'text-purple-500'}">${task.Category}</span>
                                        <span class="opacity-20">|</span>
                                        <span class="opacity-60">ðŸ“… ${formattedDate}</span>
                                        ${isHigh && task.Status === 'Active' ? `<span class="bg-red-500/10 text-red-500 px-1.5 py-0.5 rounded font-black">URGENT</span>` : ''}
                                    </div>
                                </div>
                            </div>
                            <button onclick="remove('${task.TaskID}')" class="opacity-20 hover:opacity-100 hover:text-red-500 transition-all p-2 flex-shrink-0">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </div>`;
                
                if(task.Status === 'Active') { activeCont.innerHTML += card; activeCount++; } 
                else { compCont.innerHTML += card; }
            });
            document.getElementById('countActive').innerText = activeCount;
        }

        async function saveTask() {
            const name = document.getElementById('taskInput').value;
            const priority = document.getElementById('priority').value;
            const dueDate = document.getElementById('dateInput').value;
            if(!name) return;
            setLoading(true);
            await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ action: 'addTask', data: { name, priority, dueDate } })
            });
            document.getElementById('taskInput').value = '';
            setTimeout(loadTasks, 800);
        }

        async function done(id) {
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.8 }, colors: ['#3b82f6', '#ffffff'] });
            setLoading(true);
            await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ action: 'completeTask', id: id })
            });
            setTimeout(loadTasks, 800);
        }

        async function remove(id) {
            const isDark = document.documentElement.classList.contains('dark');
            const res = await Swal.fire({
                title: 'Delete Task?',
                text: "This action cannot be undone.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, delete it',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#ef4444',
                background: isDark ? '#0f172a' : '#fff',
                color: isDark ? '#fff' : '#000',
            });
            if(res.isConfirmed) {
                setLoading(true);
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ action: 'deleteTask', id: id })
                });
                setTimeout(loadTasks, 800);
            }
        }

        function setLoading(state) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            if(state) {
                dot.className = "h-2 w-2 rounded-full bg-yellow-400 animate-pulse";
                text.innerText = "Syncing";
            } else {
                dot.className = "h-2 w-2 rounded-full bg-blue-500";
                text.innerText = "Online";
            }
        }
    </script>
</body>
</html>
